version: '3.8'

services:
  # Topic Validation Cloud Function (Port 8080)
  validate-topic:
    build:
      context: ./backend/functions/validate-topic
      dockerfile: Dockerfile
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:8080:8080"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - PORT=8080
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN:-http://localhost:3000}
    networks:
      - debate-network
    restart: unless-stopped

  # Debate Generation Cloud Function (Port 8081)
  generate-debate:
    build:
      context: ./backend
      dockerfile: functions/generate-debate/Dockerfile
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:8081:8080"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - PORT=8080
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN:-http://localhost:3000}
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/keys/gcloud-adc.json
    volumes:
      - ${HOME}/.config/gcloud/application_default_credentials.json:/tmp/keys/gcloud-adc.json:ro
    networks:
      - debate-network
    restart: unless-stopped

  # Portrait Fetching Cloud Function (Port 8082)
  get-portrait:
    build:
      context: ./backend/functions/get-portrait
      dockerfile: Dockerfile
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:8082:8083"
    environment:
      - PORT=8083
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN:-http://localhost:3000}
    networks:
      - debate-network
    restart: unless-stopped

  # Get Debate Cloud Function (Port 8084)
  get-debate:
    build:
      context: ./backend
      dockerfile: functions/get-debate/Dockerfile
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:8084:8080"
    environment:
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - PORT=8080
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN:-http://localhost:3000}
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/keys/gcloud-adc.json
    volumes:
      - ${HOME}/.config/gcloud/application_default_credentials.json:/tmp/keys/gcloud-adc.json:ro
    networks:
      - debate-network
    restart: unless-stopped

  # List Debates Cloud Function (Port 8086)
  list-debates:
    build:
      context: ./backend/functions/list-debates
      dockerfile: Dockerfile
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:8086:8080"
    environment:
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - PORT=8080
      - ALLOWED_ORIGIN=${ALLOWED_ORIGIN:-http://localhost:3000}
      - GOOGLE_APPLICATION_CREDENTIALS=/tmp/keys/gcloud-adc.json
    volumes:
      - ${HOME}/.config/gcloud/application_default_credentials.json:/tmp/keys/gcloud-adc.json:ro
    networks:
      - debate-network
    restart: unless-stopped

  # Frontend React Application (Port 3000)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "${BIND_ADDRESS:-0.0.0.0}:3000:3000"
    environment:
      - REACT_APP_VALIDATE_TOPIC_URL=http://localhost:8080
      - REACT_APP_GENERATE_DEBATE_URL=http://localhost:8081
      - REACT_APP_GET_PORTRAIT_URL=http://localhost:8082
      - REACT_APP_GET_DEBATE_URL=http://localhost:8084
    networks:
      - debate-network
      - REACT_APP_LIST_DEBATES_URL=http://localhost:8086
    networks:
      - debate-network
    depends_on:
      - validate-topic
      - generate-debate
      - get-portrait
      - get-debate
      - list-debates
networks:
  debate-network:
    driver: bridge
